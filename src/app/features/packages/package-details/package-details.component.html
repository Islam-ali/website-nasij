<div class="bg-background-color text-primary">
  <p-toast></p-toast>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
        <div class="flex flex-col items-center">
          <div class="w-full max-w-xl sticky top-">
            <div class="relative bg-white shadow-xl rounded-2xl p-6 border border-box-border">
              <p-skeleton height="400px" class="mb-4"></p-skeleton>
            </div>
          </div>
        </div>
        <div class="space-y-10">
          <p-skeleton height="60px" class="mb-4"></p-skeleton>
          <p-skeleton height="200px" class="mb-4"></p-skeleton>
          <p-skeleton height="200px" class="mb-4"></p-skeleton>
          <p-skeleton height="200px" class="mb-4"></p-skeleton>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !loading()" class="error-container">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12 text-center">
      <i class="pi pi-exclamation-triangle text-6xl text-red-500 mb-4"></i>
      <h3 class="text-xl font-semibold text-primary mb-2">
        {{ 'packages.something_went_wrong' | translate }}
      </h3>
      <p class="text-secondary mb-4">{{ error() }}</p>
      <button 
        pButton 
        [label]="'packages.try_again' | translate" 
        icon="pi pi-refresh" 
        class="p-button-primary"
        (click)="loadPackage()"
      ></button>
    </div>
  </div>

  <!-- Package Details Content -->
  <div *ngIf="!loading() && !error() && package()" class="package-content">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
        <!-- Package Images -->
        <div class="flex flex-col items-center">
          <div class="w-full max-w-xl sticky top-28">
            <div class="relative bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 border border-box-border dark:border-gray-600 overflow-hidden">
              <div class="absolute top-4 right-4 z-10">
                <span class="bg-primary-500 dark:bg-primary-500 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                  <i class="pi pi-images text-xs"></i>
                  {{ 'packages.photos' | translate: {count: images.length || 1} }}
                </span>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <img 
                  *ngFor="let image of images.slice(0, 4); let i = index"
                  [alt]="'Selected ' + (package()?.name || '') + ' ' + (i + 1)" 
                  class="w-full h-auto object-cover rounded-lg cursor-pointer transition-transform duration-300 hover:scale-105" 
                  [src]="image.itemImageSrc"
                  (error)="onImageError($event)"
                  (click)="openImageModal(image.itemImageSrc)"
                />
                <img 
                  *ngIf="images.length === 0"
                  [src]="getMainImage()" 
                  [alt]="package()?.name || ''"
                  class="w-full h-auto object-cover rounded-lg col-span-2 cursor-pointer transition-transform duration-300 hover:scale-105"
                  (error)="onImageError($event)"
                  (click)="openImageModal(getMainImage())"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Package Info -->
        <div class="space-y-10">
          <!-- Package Header -->
          <div class="relative">
            <div class="absolute -top-2 -left-2 w-4 h-4 bg-primary rounded-full opacity-20"></div>
            <div class="absolute -top-1 -left-1 w-2 h-2 bg-primary rounded-full opacity-40"></div>
            <h1 class="text-5xl font-extrabold text-primary mb-3 tracking-tight relative z-10">{{ package().name | multiLanguage }}</h1>
            <p class="text-lg text-secondary dark:text-gray-400 leading-relaxed relative z-10">{{ package().description | multiLanguage }}</p>
            <div class="my-4">
              <button type="button" (click)="share()" class="bg-primary text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                <i class="pi pi-share-alt text-xs me-2"></i>
                {{ 'products.share' | translate }}
              </button>
            </div>
          </div>

          <!-- Package Items with Variants -->
          <div class="space-y-8">
            <div *ngFor="let item of (package()?.items || [])" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border border-box-border dark:border-gray-600 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-primary flex items-center gap-2">
                  <i class="pi pi-box text-lg text-primary"></i>
                  {{ item.productId.name | multiLanguage }}
                  <span *ngIf="item.quantity > 1" class="text-base font-medium text-secondary">({{ 'packages.select_quantity' | translate: {quantity: item.quantity} }})</span>
                </h3>
                <span class=" text-gray-600 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1 shadow-md">
                  <i class="pi pi-check-circle text-xs"></i>
                  {{ 'packages.required' | translate }}
                </span>
              </div>

              <!-- Variants Selection by Quantity -->
              <div *ngIf="item.productId.variants && item.productId.variants.length > 0" class="space-y-6">
                <div *ngFor="let qty of getQuantityArray(getSelectedQuantity(item.productId._id)); let qtyIndex = index" class="space-y-6">
                  <!-- Product Image for this quantity -->
                  <div class="relative">
                    <img 
                      [alt]="item.productId.name + ' ' + (qtyIndex + 1)" 
                      class="w-full h-48 object-cover rounded-lg mb-4 border border-box-border transition-transform duration-300 ease-in-out hover:scale-105" 
                      [src]="getVariantImageForQuantity(item.productId._id, qtyIndex + 1)"
                      (error)="onImageError($event)"
                    />
                    <div class="absolute top-2 left-2 bg-primary text-white px-2 py-1 rounded-full text-xs font-semibold">
                      {{ item.productId.name | multiLanguage }} {{ qtyIndex + 1 }}
                    </div>
                  </div>

                  <!-- Color Selection -->
                  <div *ngIf="getAvailableColors(item.productId._id).length > 0" class="space-y-3">
                    <label class="text-lg font-semibold text-primary dark:text-white flex items-center gap-2">
                      <i class="pi pi-palette text-primary"></i>
                      {{ 'products.color' | translate }}
                    </label>
                    <div class="flex flex-wrap gap-3">
                      <div *ngFor="let color of getAvailableColors(item.productId._id)" class="relative group">
                        <button 
                          type="button"
                          class="color-swatch w-24 h-24 rounded-lg border-2 transition-all duration-300 relative overflow-hidden cursor-pointer"
                          [class.border-primary!important]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.border-4!important]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.scale-110]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.shadow-2xl]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.animate-pulse]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.selected]="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.hover:scale-105]="!isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.hover:shadow-lg]="!isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [class.hover:border-3]="!isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)"
                          [title]="getDisplayText(color)"
                          (click)="onColorSelectForQuantity(item.productId._id, qtyIndex + 1, color, $event)"
                        >
                          <!-- Color Image or Color Swatch -->
                          <img 
                            *ngIf="getColorImage(item.productId._id, color)"
                            [src]="getColorImage(item.productId._id, color)"
                            [alt]="getDisplayText(color)"
                            class="w-full h-full object-cover"
                            (error)="onImageError($event)"
                          />
                          <div 
                            *ngIf="!getColorImage(item.productId._id, color)"
                            class="w-full h-full rounded-lg"
                            [ngStyle]="{'background-color': getColorValue(getDisplayText(color))}"
                          ></div>
                          
                          <!-- Checkmark for selected state -->
                          <div *ngIf="isColorSelectedForQuantity(item.productId._id, qtyIndex + 1, color)" 
                               class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg">
                            <div class="bg-white rounded-full p-1">
                              <i class="pi pi-check text-green-600 text-xs font-bold"></i>
                            </div>
                          </div>
                        </button>
                        
                        <!-- Tooltip -->
                        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-2 py-1 rounded text-xs font-medium whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                          {{ getDisplayText(color) }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Size Selection -->
                  <div *ngIf="getAvailableSizes(item.productId._id).length > 0" class="space-y-3">
                    <label class="text-lg font-semibold text-primary dark:text-white flex items-center gap-2">
                      <i class="pi pi-th-large text-primary"></i>
                      {{ 'products.size' | translate }}
                    </label>
                    <div class="flex flex-wrap gap-3">
                      <button 
                        *ngFor="let size of getAvailableSizes(item.productId._id)"
                        type="button"
                        class="size-button px-4 py-2 rounded-lg border-2 transition-all duration-300 font-semibold text-sm min-w-[60px] text-center"
                        [class.border-primary!important]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.bg-primary!important]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.text-white!important]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.scale-110]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.shadow-2xl]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.animate-pulse]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.selected]="isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.hover:scale-105]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.hover:shadow-lg]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.hover:border-3]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.border-gray-300]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.text-gray-700]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [class.bg-white]="!isSizeSelectedForQuantity(item.productId._id, qtyIndex + 1, size)"
                        [title]="getDisplayText(size)"
                        (click)="onSizeSelectForQuantity(item.productId._id, qtyIndex + 1, size, $event)"
                      >
                        {{ getDisplayText(size) }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Fallback for items without variants -->
              <div *ngIf="!item.productId.variants || item.productId.variants.length === 0" class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <img 
                  [alt]="item.productId.name" 
                  class="w-full h-48 object-cover rounded-lg border border-box-border transition-transform duration-300 ease-in-out hover:scale-105" 
                  [src]="(item.productId.images[0].filePath) || 'assets/images/placeholder.jpg'"
                  (error)="onImageError($event)"
                />
                <div>
                  <p class="text-sm text-secondary">This item is included in your package</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Quantity and Actions -->
          <div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 dark:border-gray-600 p-8 rounded-2xl shadow-lg border border-box-border">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg">
                  <button 
                    class="px-3 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 hover:bg-gray-100 hover:scale-105 rounded-l-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="decreaseQuantity()"
                    [disabled]="quantity <= 1"
                  >
                    <i class="pi pi-minus text-sm"></i>
                  </button>
                  <span class="px-4 py-2 font-semibold text-lg">{{ quantity }}</span>
                  <button 
                    class="px-3 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 hover:bg-gray-100 hover:scale-105 rounded-r-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="increaseQuantity()"
                    [disabled]="quantity >= (package().stock || 1)"
                  >
                    <i class="pi pi-plus text-sm"></i>
                  </button>
                </div>
                <div *ngIf="getSavings() > 0" class="flex flex-col gap-1">
                <p class="text-sm text-green-600 dark:text-green-400 font-semibold flex items-center gap-1">
                  <i class="pi pi-check-circle text-xs"></i>
                  {{ 'packages.you_save_amount' | translate: {amount: getSavings().toFixed(2)} }}
                </p>
                <p class="text-sm text-secondary dark:text-gray-400 flex items-center gap-1">
                  <i class="pi pi-tag text-xs"></i>
                  <span class="line-through">${{ getTotalValue().toFixed(2) }}</span>
                </p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm text-secondary dark:text-gray-400 flex items-center justify-end gap-1">
                  <i class="pi pi-dollar text-xs"></i>
                  {{ 'packages.total_price' | translate }}
                </p>
                <p class="text-4xl font-extrabold text-primary">${{ getPackageTotalPrice().toFixed(2) }}</p>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 mt-8">
                <button type="button"
                  class="w-full py-5 text-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-primary-400 to-primary-600 dark:from-primary-500 dark:to-primary-500 hover:from-primary-700 hover:to-primary-700 dark:hover:from-primary-600 dark:hover:to-primary-600 text-white rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300"
                  [disabled]="!package().stock || package().stock === 0" (click)="addToCart()" pTooltip="Add item to your shopping cart" tooltipPosition="top">
                  <i class="pi pi-shopping-cart mr-3"></i>
                  {{ 'products.add_to_cart' | translate }}
                </button>
  
                <!-- Buy Now Button -->
                <button type="button"
                  class="w-full py-5 text-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-primary-400 to-primary-600 dark:from-primary-500 dark:to-primary-500 hover:from-primary-700 hover:to-primary-700 dark:hover:from-primary-600 dark:hover:to-primary-600 text-white rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300"
                  [disabled]="!package().stock || package().stock === 0" (click)="buyNow()" pTooltip="Checkout" tooltipPosition="top">
                  <i class="pi pi-shopping-cart mr-3"></i>
                  {{ 'packages.buy_now' | translate }}
                </button>
              </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
/* Color and Size Selection Styles */
.color-swatch-ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.6);
  transform: scale(0);
  animation: ripple 0.6s linear;
  pointer-events: none;
}

@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* Enhanced hover effects for color swatches */
.color-swatch:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.color-swatch.selected {
  transform: scale(1.15);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
}

/* Size button enhancements */
.size-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.size-button.selected {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Smooth transitions */
.color-swatch,
.size-button {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark mode enhancements */
.dark .color-swatch {
  border-color: #374151;
}

.dark .color-swatch:hover {
  border-color: #6b7280;
}

.dark .size-button {
  border-color: #374151;
  background-color: #1f2937;
  color: #d1d5db;
}

.dark .size-button:hover {
  border-color: #6b7280;
  background-color: #374151;
}

.dark .size-button.selected {
  background-color: #3b82f6;
  border-color: #3b82f6;
  color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {  
  .size-button {
    min-width: 50px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }
}

/* Animation for selection feedback */
@keyframes selection-pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.selection-feedback {
  animation: selection-pulse 0.3s ease-in-out;
}
</style> 